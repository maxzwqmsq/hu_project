var BenImageResizer=function(e){var d={resizeMode:"auto",dataSource:"",dataSourceType:"image",maxWidth:150,maxHeight:200,onTmpImgGenerate:function(g){},success:function(h,g){},debug:false};var c={};$.extend(d,e);var f=function(h,g){if(d.debug==true){if(g){console.log(h,g)}else{console.log(h)}}};var b={getBase4FromImgFile:function(h,i){var g=new FileReader();g.onload=function(k){var j=k.target.result;if(i){i(j)}};g.readAsDataURL(h)},getImgFromDataSource:function(h,i,k){var g=this;var j=new Image();if(i=="img"||i=="image"){j.src=$(h).attr("src");if(k){k(j)}}else{if(i=="base64"){j.src=h;if(k){k(j)}}else{if(i=="canvas"){j.src=h.toDataURL("image/jpeg");if(k){k(j)}}else{if(i=="file"){g.getBase4FromImgFile(function(l){j.src=l;if(k){k(j)}})}}}}},getResizeSizeFromImg:function(j){var m={w:$(j)[0].naturalWidth,h:$(j)[0].naturalHeight};console.log("真实尺寸：");console.log(m);var k={w:0,h:0};if(m.w<=d.maxWidth&&m.h<=d.maxHeight){return m}if(d.resizeMode=="auto"){var i=parseFloat(m.w/m.h);var g={w:0,h:0};var l={w:d.maxWidth,h:parseInt(d.maxWidth/i)};var h={w:parseInt(d.maxHeight*i),h:d.maxHeight};if(l.h<=d.maxHeight){return l}if(h.w<=d.maxWidth){return h}return{w:d.maxWidth,h:d.maxHeight}}if(d.resizeMode=="width"){if(m.w<=d.maxWidth){return m}var l={w:d.maxWidth,h:parseInt(d.maxWidth/i)};return l}if(d.resizeMode=="height"){if(m.h<=d.maxHeight){return m}var h={w:parseInt(d.maxHeight*i),h:d.maxHeight};return h}},drawToCanvas:function(k,j,g,l,h,n){var i=document.createElement("canvas");i.width=j;i.height=g;var o=i.getContext("2d");o.drawImage(k,0,0,l,h,0,0,j,g);var m=i.toDataURL("image/jpeg");if(n){n(m,i)}}};(function(){b.getImgFromDataSource(d.dataSource,d.dataSourceType,function(g){setTimeout(function(){var h=g;d.onTmpImgGenerate(g);var i=b.getResizeSizeFromImg(h);console.log(i);var j={w:$(h)[0].naturalWidth,h:$(h)[0].naturalHeight};b.drawToCanvas(h,i.w,i.h,j.w,j.h,function(l,k){d.success(l,k)})},1000)})})();var a={};return a};var BenUploadUtils=function(k){var d={dom:"",url:"",limitSize:1024,limitFormat:"gif,jpg,jpeg,png,GIF,JPG,PNG",limitFormatCallback:function(l){},limitSizeCallback:function(l){},onUploadCallback:function(l){},onUploadBeforeCallback:function(l){},onUploadSuccessCallback:function(l){},onUploadFailCallback:function(l){},onUploadAlwaysCallback:function(l){}};$.extend(d,k);var g=function(l){return $(l)[0].files[0].size};var c=function(l){return $(l)[0].files[0].type};var f=function(){$(d.dom).on("change",function(m){if(b(this)&&i(this)){var l=new FileReader();var n=$(this)[0].files[0];l.onload=function(p){var o=p.target.result;d.onRenderResizerBefore(o);BenImageResizer({resizeMode:"auto",dataSource:o,dataSourceType:"base64",maxWidth:1200,maxHeight:600,debug:true,onTmpImgGenerate:function(q){},success:function(r,q){d.onRenderResizerAfter(r);a(r)}})};l.readAsDataURL(n)}})};var b=function(m){var l=g(m);if(l>d.limitSize){d.limitSizeCallback({errorCode:500,data:"",msg:"图片不能大于"+d.limitSize+"kb"});return false}else{d.limitSizeCallback({errorCode:200,data:"",msg:"在设置的图片大小范围内"});return true}};var i=function(l){var m=c(l);if(!new RegExp("(jpg|jpeg|png)+","gi").test(m)){d.limitFormatCallback({errorCode:500,data:"",msg:"图片格式不正确，请上传"+d.limitFormat+"的其中一个格式"});return false}else{d.limitFormatCallback({errorCode:200,data:"",msg:"在设置的图片格式范围内"});return true}};var e=function(){f()};var h=function(){if($.fn&&$.fn.jquery){return true}return false};var a=function(l){if(h()){$.ajax({url:d.url,type:"POST",dataType:"JSON",data:l||"",beforeSend:function(){d.onUploadBeforeCallback()}}).done(function(m){d.onUploadSuccessCallback(m)}).fail(function(m){d.onUploadFailCallback(m)}).always(function(){d.onUploadAlwaysCallback()})}else{$.ajax({url:d.url,type:"POST",dataType:"JSON",data:l||"",beforeSend:function(){d.onUploadBeforeCallback()},success:function(m){d.onUploadSuccessCallback(m)},error:function(m){d.onUploadFailCallback(m)},complete:function(){d.onUploadAlwaysCallback()}})}};var j=function(){e()};return{init:j}};